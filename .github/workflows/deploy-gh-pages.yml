name: Deploy GH Pages (dev + run archive)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Prepare publish content
        run: |
          # create small temp folder containing index.html to publish
          mkdir -p publish_tmp
          cp index.html publish_tmp/

      - name: Prepare gh-pages branch
        run: |
          # 1. Configure Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # 2. Move the NEW report to a safe temporary location
          #    (so it doesn't get messed up during git checkout)
          mv publish_tmp /tmp/new_report

          # 3. Fetch and switch to existing content (if it exists)
          #    We do this to get the OLD folders (previous run IDs) into our working directory.
          git fetch origin gh-pages || true

          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            echo "Branch exists. Checking out current content..."
            git checkout origin/gh-pages
          else
            echo "Branch does not exist. Starting fresh..."
            git checkout --orphan gh-pages
          fi

          # 4. Create the "One Commit" state
          #    Create a new orphan branch. This disconnects the history.
          git checkout --orphan deploy-branch
          git reset .  # Unstage everything. Files are now 'untracked' but present on disk.

          # 5. Clean up OLD data
          #    Remove old 'dev' folder
          rm -rf dev

          #    Retention Logic: Keep only the newest 5 run-id folders.
          #    List all numeric directories -> Sort Numerically -> Select all except last 5 -> Delete them
          find . -maxdepth 1 -type d -regex "./[0-9]+" | sort -n | head -n -5 | xargs -I {} rm -rf "{}"

          # 6. Add NEW data
          #    Bring the new report back as 'dev' and copy it to 'run_id'
          mv /tmp/new_report dev
          cp -r dev "${GITHUB_RUN_ID}"

          # 7. Commit and Force Push
          git add .
          git commit -m "Deploy report: Run ${GITHUB_RUN_ID}"

          #    Force push to gh-pages (overwriting history completely)
          git push origin deploy-branch:gh-pages --force


      # - name: Publish latest to dev (gh-pages/dev)
      #   uses: peaceiris/actions-gh-pages@v4
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: publish_tmp
      #     destination_dir: dev
      #     # keep_files: true not required when publishing to a subdir,
      #     # action will update the subdir; other files remain untouched
      #     keep_files: false

      # - name: Publish snapshot to RUN_ID (archive)
      #   uses: peaceiris/actions-gh-pages@v4
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: publish_tmp
      #     destination_dir: ${{ github.run_id }}
      #     keep_files: false

      