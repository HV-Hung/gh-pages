name: Deploy GH Pages (dev + run archive)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  tag:
    name: Tag Release
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    outputs:
      version: ${{ steps.get-release-version.outputs.version }}
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: wemogy/get-release-version-action@v4.3.2
        id: get-release-version
        with:
          git-username: jtl
          git-email: npm@jtl-cloud.com
          mode: 'semantic'

  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Prepare RUN_ID
        id: runid
        run: echo "RUN_ID=$(date +%s)" >> $GITHUB_ENV

      - name: Ensure .nojekyll exists (optional)
        run: |
          [[ -f .nojekyll ]] || printf "" > .nojekyll

      - name: Prepare gh-pages branch (clean only if exists)
        run: |
          set -euo pipefail

          # Check if remote gh-pages exists
          if git ls-remote --exit-code --heads origin gh-pages >/dev/null 2>&1; then
            echo "gh-pages exists â†’ cleaning branch"
            GH_EXISTS=true
          else
            echo "gh-pages does NOT exist â†’ skip cleaning"
            GH_EXISTS=false
          fi

          if [ "$GH_EXISTS" = false ]; then
            exit 0  # nothing to clean, let deploy step create branch
          fi

          # ========== CLEANING PROCESS ==========
          git fetch origin gh-pages
          git checkout --orphan temp-gh-pages
          git reset

          # checkout latest content into working tree
          git checkout origin/gh-pages -- . || true

          # always keep these
          keep=(.nojekyll CNAME dev)

          # find last 5 numeric run folders
          last5=$(ls -1d [0-9]* 2>/dev/null | sort -n | tail -5 || true)
          read -r -a arr <<<"$last5"
          keep+=("${arr[@]}")

          # remove everything except keep list
          for item in * .[!.]* ..?*; do
            [ -e "$item" ] || continue
            [[ "$item" == ".git" ]] && continue
            [[ "$item" == "." || "$item" == ".." ]] && continue

            found=false
            for k in "${keep[@]}"; do
              [[ "$item" == "$k" ]] && found=true
            done
            $found || rm -rf "$item"
          done

          # ensure keep dirs/files exist
          for k in "${keep[@]}"; do
            if [[ "$k" == ".nojekyll" || "$k" == "CNAME" ]]; then
              [[ -f "$k" ]] || touch "$k"
            else
              mkdir -p "$k"
            fi
          done

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # stage only existing keep items
          add_list=()
          for k in "${keep[@]}"; do
            [[ -e "$k" ]] && add_list+=("$k")
          done

          git add -- "${add_list[@]}"

          git commit -m "Clean gh-pages: keep last 5 run folders + dev"

          git branch -D gh-pages || true
          git branch -m gh-pages
          git push origin gh-pages --force

      - name: Prepare publish content
        run: |
          # create small temp folder containing index.html to publish
          mkdir -p publish_tmp
          cp index.html publish_tmp/

      - name: Publish latest to dev (gh-pages/dev)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: publish_tmp
          destination_dir: dev
          # keep_files: true not required when publishing to a subdir,
          # action will update the subdir; other files remain untouched
          keep_files: false

      - name: Publish snapshot to RUN_ID (archive)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: publish_tmp
          destination_dir: ${{ github.run_id }}
          keep_files: false
